<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test</title>
    <style>
        body {
            margin: 0;
        }
        #out {
            background-color: rgb(255, 255, 255);
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>
<body>
    <div id="controls">
        <button id="clearClicks_Btn">Clear</button>
        <button id="undoClick_Btn">Undo</button>
        <input type="number" id="changeRadius_NS" min="2" max="128" value="12" required>
        <input type="color" id="colorChoice">
    </div>
    <div id="out">
    </div>
    
    <!-- <script src="/socket.io/socket.io.js"></script> -->
    <script src="https://cdn.socket.io/4.4.1/socket.io.js"></script>
    <script>
        const socket = io();

        let circles = [];
        let _clientId;
        
        const circle = (x, y, radius=localRadius, color='black') => {
            const element = document.createElement('div');
            element.style.width = `${radius}px`;
            element.style.height = `${radius}px`;
            element.style.borderRadius = '100%';
            element.style.position = 'fixed';
            element.style.backgroundColor = color;
            element.style.top = `${y}px`;
            element.style.left = `${x}px`;
            return element;
        };
        
        const clearClicks_Btn = document.querySelector('#clearClicks_Btn');
        const undoClick_Btn = document.querySelector('#undoClick_Btn');
        const changeRadius_NS = document.querySelector('#changeRadius_NS');
        const colorChoice = document.querySelector('#colorChoice');
        const out = document.querySelector('#out');
        
        let localRadius = changeRadius_NS.value;
        let localColor = colorChoice.value;


        // on client connection to socket.io
        socket.on('clientConnected', function onClientConnected(clientId) {
            // get a private uuid to verify this clients identity on the server side
            _clientId = clientId;
            console.log(`Connected with clientId: ${_clientId}`);

            // get the click points from the server
            socket.emit('retrieve', _clientId);
        });
        
        // on click points retrieved from the server
        socket.on('clicks', function onClicksRetrieved(points) {
            // clear old circles, in case of reconnecting etc
            clearItems();

            // create an Array of div elements (circle) from each item in points
            circles = points.map(point => circle(point.x, point.y, point.radius, point.color));
            // append each circle to the out div
            circles.forEach(c => out.append(c));
            
            //console.log(circles);
            //console.log(points);
        });
        
        // on new click from another client
        socket.on('click', function onClientClick(msgObj) {
            const {x, y, radius, color} = msgObj;
            const c = circle(x, y, radius, color);

            circles.push(c);

            // append circle to the out div
            out.append(c);

            console.log(`Client clicked:  X: ${x}  Y: ${y}  radius: ${radius}  color: ${color}`);
        });

        // clear items called from the server
        socket.on('clearItems', function onClearItems() {
            console.log('clearItems called from the server, CLEARING');

            clearItems();
        });
        
        // TODO merge into clearItems and pass the specific item(s) to clear
        socket.on('undoItem', function onUndoItem() {
            // undo item called from the server
            console.log('undoItem called from the server, UNDOING');

            // pop the last item from the circles Array, ugly but shorthand didnt work?
            if (circles.length) { circles.pop(); } else { return; }

            // remove the last element from the out div
            out.removeChild(out.lastChild);
        });


        // on mouse click
        document.addEventListener('click', function onMouseClick(e) {
            // if we didnt click something in controls, TODO fix, howto check if it is type HTMLButtonElement etc, or in controls div?
            if ((e.target.id == 'clearClicks_Btn') || (e.target.id == 'undoClick_Btn') || (e.target.id == 'changeRadius_NS') || (e.target.id == 'colorChoice')) return;

            // get x,y from the click event object
            const {x,y} = e;

            // TEST add new clicks to circles Array
            // append a new circle to the out div
            const c = circle(x, y, localRadius, localColor);
            circles.push(c);
            out.append(c);

            // send an object to the server with the private uuid (clientId),
            // the color and radius chosen, and x, y coordinates
            socket.emit('click', {clientId: _clientId, color: localColor, radius: localRadius, x, y});

            console.log(`Clicked  X: ${x} Y: ${y}  target: ${e.target}  currentTarget: ${e.currentTarget}  circles.length: ${circles.length}`);
        });
        
        // clicked the clear button
        function clearClicks_Btn_onClickHandler(e) {
            console.log(`CLEAR  ${e.target.id}  target: ${e.target}  currentTarget: ${e.currentTarget}  out.childNodes.length: ${out.childNodes.length}  circles.length: ${circles.length}`);
            
            clearItems();

            // tell the server to clear items
            socket.emit('clearItems', _clientId);
        }
        
        // undo a click
        function undoClick_Btn_onClickHandler(e) {
            console.log(`UNDO  ${e.target.id}  target: ${e.target}  currentTarget: ${e.currentTarget}  out.childNodes.length: ${out.childNodes.length}  circles.length: ${circles.length}`);
            
            // pop the last item from the circles Array, ugly but shorthand didnt work?
            if (circles.length) { circles.pop(); } else { return; }

            // remove the last element from the out div
            out.removeChild(out.lastChild);

            // then send undo to the server
            socket.emit('undoItem', _clientId);
        }
        
        // the radius changed
        function changeRadius_NS_onChangeHandler(e) {
            localRadius = changeRadius_NS.value;
            console.log(`Radius changed  ${localRadius}  ${e.target.id}  target: ${e.target}  currentTarget: ${e.currentTarget}`);
        }
        
        // color changed
        function colorChoice_onChangeHandler(e) {
            localColor = colorChoice.value;
            console.log(`Color changed  ${localColor}  ${e.target.id}  target: ${e.target}  currentTarget: ${e.currentTarget}`);
        }
        

        // remove all circles
        function clearItems() {
            // for testing
            //circles.splice(0, circles.length);
            //circles.length = 0;
            
            // empty the circles Array
            while (circles.length) {
                circles.pop();
            }
            
            // remove all div elements from the out div
            // NOTE created a separate div for controls, to not 
            // delete them from the out div while deleting circles
            removeAllChildNodes(out);
        }

        // remove elements from a parent element
        function removeAllChildNodes(parent) {
            while (parent.firstChild) {
                parent.removeChild(parent.firstChild);
            }
        }

        // controls
        clearClicks_Btn.addEventListener('click', clearClicks_Btn_onClickHandler);
        undoClick_Btn.addEventListener('click', undoClick_Btn_onClickHandler);
        changeRadius_NS.addEventListener('change', changeRadius_NS_onChangeHandler);
        colorChoice.addEventListener('change', colorChoice_onChangeHandler);

    </script>
</body>
</html>